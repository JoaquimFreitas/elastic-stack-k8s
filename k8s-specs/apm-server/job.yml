apiVersion: batch/v1
kind: Job
metadata:
  namespace: pets
  name: apm-template-init-job
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-elasticsearch
        image: appropriate/curl
        imagePullPolicy: IfNotPresent
        args:
        - "sh"
        - "-c"
        - "while [ $(curl -sw '%{http_code}' 'http://elasticsearch.pets.svc.cluster.local:9200/_cluster/health?pretty' -o /dev/null) -ne 200 ]; do sleep 15; done"
      containers:
      - name: create-apm-template
        image: docker.elastic.co/apm/apm-server:6.6.1
        command: [ "apm-server", "setup", "--template",
          "-E", "output.kafka.enabled=false",
          "-E", 'setup.template.name="apm-server"',
          "-E", 'setup.template.pattern="apm-server-*"',
          "-E", 'output.elasticsearch.hosts=["elasticsearch.pets.svc.cluster.local:9200"]']
      - name: force-kibana-new-documents
        image: "appropriate/curl"
        imagePullPolicy: IfNotPresent
        command: ["curl", "-XDELETE", "elasticsearch.pets.svc.cluster.local:9200/apm-server-*"]
      restartPolicy: Never